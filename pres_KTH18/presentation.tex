\documentclass{beamer}

\beamertemplatenavigationsymbolsempty

\usepackage{etex}
\input{preamble/packages}
\input{preamble/extpackages}
\input{preamble/declarations}
\input{preamble/extdeclarations}
%normal red is too bright
\definecolor{red}{HTML}{800000} 

%\usepackage{bm}


% \C is used inside figures created by inkscape, which sadly does not have good alignment support for tex.
\newcommand\C[1]{\raisebox{-0.5\height}{\texttt{#1}}} 

\title{Verifying Concurrent Operating Systems}
\author{Jonas Oberhauser}
\date{\today} % Date, can be changed to a custom date
\begin{document}
\begin{frame}
\titlepage % Print the title page as the first slide
\end{frame}


\begin{frame}
Sequential verification
\begin{center}
	\texttt{
		\begin{tabular}{l}
			i++; 
		\\ i++;
		\end{tabular}
	}
\end{center}

After execution do we have 
\[ \texttt{i} = 2 \ ? \]

Trivial
\end{frame}



\begin{frame}
In reality (e.g., on MIPS):
\begin{center}
	\texttt{
		\begin{tabular}{l}
			fetch;
			\\t1 = i;
			\\fetch;
			\\ t1 = t1 + 1; 
			\\fetch;
			\\ i = t1;
			\\
			\\ fetch;
			\\ t1 = i;
			\\ fetch;
			\\ t1 = t1 + 1; 
			\\ fetch;
			\\ i = t1;
		\end{tabular}
	}
\end{center}

After execution do we have 
\[ \texttt{i} = 2 \ ? \]

Equally Trivial
\end{frame}


\begin{frame}
Multiple threads, shared state

\begin{center}
	\texttt{
		\begin{tabular}{l||l}
			i++; & i++;
		\end{tabular}
	}
\end{center}

After execution do we have 
\[ \texttt{i} = 2 \ ? \]

\end{frame}


\begin{frame}
Interleavings:

\begin{center}
	\scalebox{.6}{
		\begin{tabular}{ccc}
			\includefig{increment_coarse12} & \hspace{4em} & \includefig{increment_coarse21} 
		\end{tabular}}
\end{center}
\end{frame}


\begin{frame}
Break up into small steps:

\begin{center}
	\texttt{
		\begin{tabular}{l||l}
			t1 = i; & t2 = i;
		\\	i = t1+1; & i = t2+1;
		\end{tabular}
	}
\end{center}

\onslide<2->
Look at all interleavings:


\begin{center}
	\scalebox{.45}{
		\begin{tabular}{ccccc}
			\includefig{increment_schedule1122} & \hspace{4em} & \includefig{increment_schedule1212} & \hspace{4em} & \includefig{increment_schedule1221}\\
			\includefig{increment_schedule2211} & \hspace{4em} & \includefig{increment_schedule2121} & \hspace{4em} & \includefig{increment_schedule2112}	
	\end{tabular}}
\end{center}

New behavior:
\[ \texttt{i} = 1 \ \lor \ \texttt{i} = 2 \]
\end{frame}




\begin{frame}
Break up into smaller steps:

\begin{center}
	\texttt{
		\begin{tabular}{l||l}
			fetch; & fetch;
			\\ t1 = i; & t2 = i;
			\\ fetch; & fetch;
			\\ t1 = t1+1; & t2 = t2+1;
			\\ fetch; & fetch;
			\\ i = t1; & i = t2;
		\end{tabular}
	}
\end{center}

New behaviors?

Look at all 924 interleavings???
\onslide<2->
\begin{center}
	\scalebox{0.6}{\includegraphics{figures/nope-im-out}}
\end{center}
\end{frame}

\begin{frame}
Step 1 to a better life: \textbf{order reduction}

\begin{enumerate} 
	\item Answers the question: 
	
	\begin{center}
		``When did we break it up enough to get all possible behaviors?''
	\end{center}
	\item Theorem: if program satisfies some software conditions, breaking it down further will not add new behaviors
\end{enumerate}
\end{frame}



\begin{frame}
Breaking up can be modeled by cooperative vs preemptive interleaving

\begin{center}
	\texttt{
		\begin{tabular}{l||l}
			t1 = i, & t2 = i,
			\\	i = t1+1; & i = t2+1;
		\end{tabular}
	}
\end{center}

\begin{description}
	\item<2->[Cooperative scheduler] will only interleave at `;' (called \textbf{interleaving points} (IP))
	
	\begin{center}
		\scalebox{.3}{
			\begin{tabular}{ccc}
				\includefig{increment_schedule1122} & \hspace{4em} & \includefig{increment_schedule2211} \\
		\end{tabular}}
	\end{center}
	\item<3->[Preemptive scheduler] will interleave at `;' and `,'
	
	\begin{center}
		\scalebox{.3}{
			\begin{tabular}{ccccc}
				\includefig{increment_schedule1122} & \hspace{4em} & \includefig{increment_schedule1212} & \hspace{4em} & \includefig{increment_schedule1221}\\
				\includefig{increment_schedule2211} & \hspace{4em} & \includefig{increment_schedule2121} & \hspace{4em} & \includefig{increment_schedule2112}	
		\end{tabular}}
	\end{center}
\end{description}

\end{frame} 



\begin{frame}
\begin{center}
	\texttt{
		\begin{tabular}{l||l}
			t1 = i, & t2 = i,
			\\	i = t1+1; & i = t2+1;
		\end{tabular}
	}
\end{center}

Observation: 
\begin{enumerate} 
	\item \texttt{t1} only accessed by Thread 1
	\item \texttt{t2} only accessed by Thread 2
	\item \texttt{i} accessed by both, concurrently
\end{enumerate}

Make this formal with ownership
\end{frame} 

\begin{frame}
\alt<2->{\alt<3->{Introduce dynamic ownership:
		\begin{center}
			\includefig{MLayoutOwnedByTwo}
	\end{center}}{Introduce dynamic ownership:
		\begin{center}
			\includefig{MLayoutOwnedAnnotated}
\end{center}}}{Basic layout: processor registers and shared memory
	\begin{center}
		\includefig{MLayoutUnowned}
\end{center}}
\end{frame} 


\begin{frame}
\textbf{Software Condition 1)}: annotate accesses based on ownership as local or shared

\begin{center}
	\includefig{MLayoutOwnedAnnotations}
\end{center}

Shared access is \textbf{linearization point} (LP)
\end{frame} 

\begin{frame}
\textbf{Software Condition 2)}: at most one LP between two IPs

Violated:
\begin{center}
	\texttt{
		\begin{tabular}{l||l}
			t1 = \{i\}, & t2 = \{i\},
			\\	\{i\} = t1+1; & \{i\} = t2+1;
		\end{tabular}
	}
\end{center}

Satisfied:
\begin{center}
\texttt{
	\begin{tabular}{l||l}
		fetch, & fetch,
		\\ t1 = \{i\}; & t2 = \{i\};
		\\ fetch, & fetch,	
		\\ t1 = t1 +1, & t2 = t2 + 1,
		\\ fetch, & fetch,
		\\	\{i\} = t1; & \{i\} = t2;
	\end{tabular}
}
\end{center}
\end{frame}


\begin{frame}
\textbf{Software Condition 3)} (technical): After reaching LP, an IP must be reachable

Violated:
\begin{center}
\texttt{
	\begin{tabular}{l}
		\{i\} = 1,
		\\ while(1) \{
		\\ \};
	\end{tabular}
}
\end{center}
\end{frame} 

\begin{frame}
Checking safety
\begin{center}
	\texttt{
		\begin{tabular}{l||l}
			fetch, & fetch,
			\\ t1 = \{i\}; & t2 = \{i\};
			\\ fetch, & fetch,	
			\\ t1 = t1 +1, & t2 = t2 + 1,
			\\ fetch, & fetch,
			\\	\{i\} = t1; & \{i\} = t2;
		\end{tabular}
	}
\end{center}
\end{frame}


\bibliography{bibliography}



\end{document}